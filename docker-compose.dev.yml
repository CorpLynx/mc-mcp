version: '3.8'

# Development Docker Compose configuration
# This setup includes hot-reloading and development tools

services:
  # Bridge Server - Development mode with volume mounts
  bridge-server:
    build:
      context: .
      dockerfile: packages/bridge-server/Dockerfile
      target: builder  # Use builder stage for dev dependencies
    container_name: minecraft-bridge-server-dev
    ports:
      - "8080:8080"  # WebSocket port
      - "8081:8081"  # Health check port
      - "9229:9229"  # Node.js debugger port
    environment:
      PORT: 8080
      MCP_AUTH_TOKENS: ${MCP_AUTH_TOKENS:-dev-mcp-token}
      MINECRAFT_AUTH_TOKEN: ${MINECRAFT_AUTH_TOKEN:-dev-minecraft-token}
      MESSAGE_QUEUE_SIZE: ${MESSAGE_QUEUE_SIZE:-1000}
      HEARTBEAT_INTERVAL: ${HEARTBEAT_INTERVAL:-30000}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      NODE_ENV: development
    volumes:
      # Mount source code for hot-reloading
      - ./packages/bridge-server/src:/app/packages/bridge-server/src
      - ./packages/shared/src:/app/packages/shared/src
      # Mount node_modules as volume to prevent overwriting
      - bridge-node-modules:/app/node_modules
      - bridge-server-node-modules:/app/packages/bridge-server/node_modules
      - shared-node-modules:/app/packages/shared/node_modules
    command: npm run dev  # Assumes you add a dev script with nodemon
    restart: unless-stopped
    networks:
      - minecraft-mcp-network

  # MCP Server - Development mode with volume mounts
  mcp-server:
    build:
      context: .
      dockerfile: packages/mcp-server/Dockerfile
      target: builder  # Use builder stage for dev dependencies
    container_name: minecraft-mcp-server-dev
    ports:
      - "9230:9229"  # Node.js debugger port (different from bridge)
    environment:
      BRIDGE_URL: ws://bridge-server:8080
      AUTH_TOKEN: ${MCP_AUTH_TOKEN:-dev-mcp-token}
      RECONNECT_ATTEMPTS: ${RECONNECT_ATTEMPTS:-5}
      RECONNECT_DELAY: ${RECONNECT_DELAY:-1000}
      LOG_LEVEL: ${MCP_LOG_LEVEL:-DEBUG}
      MCP_SERVER_NAME: ${MCP_SERVER_NAME:-minecraft-mcp-server-dev}
      MCP_SERVER_VERSION: ${MCP_SERVER_VERSION:-1.0.0-dev}
      NODE_ENV: development
    volumes:
      # Mount source code for hot-reloading
      - ./packages/mcp-server/src:/app/packages/mcp-server/src
      - ./packages/shared/src:/app/packages/shared/src
      # Mount node_modules as volume
      - mcp-node-modules:/app/node_modules
      - mcp-server-node-modules:/app/packages/mcp-server/node_modules
      - shared-node-modules:/app/packages/shared/node_modules
    command: npm run dev  # Assumes you add a dev script with nodemon
    restart: unless-stopped
    depends_on:
      - bridge-server
    networks:
      - minecraft-mcp-network

  # Optional: Redis for caching/session management in development
  redis:
    image: redis:7-alpine
    container_name: minecraft-redis-dev
    ports:
      - "6379:6379"
    networks:
      - minecraft-mcp-network

  # Optional: PostgreSQL for persistent storage in development
  postgres:
    image: postgres:15-alpine
    container_name: minecraft-postgres-dev
    environment:
      POSTGRES_USER: minecraft
      POSTGRES_PASSWORD: minecraft
      POSTGRES_DB: minecraft_mcp
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - minecraft-mcp-network

networks:
  minecraft-mcp-network:
    driver: bridge
    name: minecraft-mcp-network-dev

volumes:
  # Node modules volumes to prevent overwriting from host
  bridge-node-modules:
  bridge-server-node-modules:
  mcp-node-modules:
  mcp-server-node-modules:
  shared-node-modules:
  # Database volumes
  postgres-data:
